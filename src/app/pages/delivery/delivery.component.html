<p-toast></p-toast>

<div class="grid">
    <div class="botones-container">
        <button pButton type="button" label="Ir al Login" icon="pi pi-user-shield" class="boton-inicio" (click)="IrInicio()"></button>
    </div>

    <!-- Ubicaci贸n actual -->
    <div class="ubicacion-actual">
        <p *ngIf="ubicacionActual">
            <i class="pi pi-map-marker"></i> Ubicaci贸n actual: 
            Lat: {{ ubicacionActual.lat | number:'1.4-4' }}, 
            Lng: {{ ubicacionActual.lng | number:'1.4-4' }}
        </p>
        <p *ngIf="!ubicacionActual" class="text-warning">
            <i class="pi pi-spinner pi-spin"></i> Obteniendo ubicaci贸n...
        </p>
    </div>

    <!-- Estado del delivery -->
    <div class="estado-delivery">
        <p>Estado del delivery:</p>
        <button pButton 
                type="button" 
                [label]="deliveryState" 
                [icon]="deliveryState === 'Activo' ? 'pi pi-check-circle' : 'pi pi-times-circle'"
                [class]="getStateButtonClass()"
                [disabled]="updatingState"
                (click)="toggleDeliveryState()">
            <span *ngIf="updatingState" class="pi pi-spinner pi-spin"></span>
            <span *ngIf="!updatingState">{{ deliveryState }}</span>
        </button>
    </div>


    <!-- Mapa (columna de 8 en pantallas grandes) -->
    <div class="col-12 lg:col-8">
        <p-card header="Mapa de Repartidores" styleClass="h-full">
            <app-map [initialCoords]="[20.5888, -100.3899]" [currentLocation]="ubicacionActual" [initialZoom]="13"></app-map>
        </p-card>
    </div>

    <!-- Tabla para mostrar los paquetes -->
    <div class="tabla-container">
        <p-table [value]="paquetes" [loading]="loading" class="tabla-centrada">
            <ng-template pTemplate="header">
                <tr>
                    <th>ID</th>
                    <th>Direcci贸n de entrega</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-paquete>
                <tr>
                    <td>{{ paquete.id }}</td>
                    <td>{{ paquete.direccion }}</td>
                    <td [ngClass]="getStatusClass(paquete.estado)">{{ paquete.estado }}</td>
                    <td>
                        <ng-container *ngIf="showActions(paquete.estado); else statusOnly">
                            <button pButton 
                                    icon="pi pi-check" 
                                    class="p-button-success"
                                    [disabled]="updatingStatus[paquete.id]"
                                    (click)="entregarPaquete(paquete)">
                                    <span *ngIf="updatingStatus[paquete.id]" class="pi pi-spinner pi-spin"></span>
                                    <span *ngIf="!updatingStatus[paquete.id]">Entregar</span>
                            </button>
                            <button pButton 
                                    icon="pi pi-times"
                                    class="p-button-danger ml-2"
                                    [disabled]="updatingStatus[paquete.id]"
                                    (click)="cancelarPaquete(paquete)">
                                    <span *ngIf="updatingStatus[paquete.id]" class="pi pi-spinner pi-spin"></span>
                                    <span *ngIf="!updatingStatus[paquete.id]">Cancelar</span>
                            </button>
                        </ng-container>
                        <ng-template #statusOnly>
                            <span class="status-badge" [ngClass]="getStatusClass(paquete.estado)">
                                {{ paquete.estado }}
                            </span>
                        </ng-template>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="4" class="text-center">
                        No hay paquetes asignados
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>